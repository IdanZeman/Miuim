# מסמך תיעוד לוגיקת נוכחות (Attendance Logic)

מסמך זה מתאר את הלוגיקה העסקית המורכבת מאחורי מערכת הנוכחות במערכת "Miuim".
המערכת משתמשת בשילוב של נתונים ידניים, אלגוריתם, בקשות יציאה ולוגיקת הסקה (Inference) כדי לקבוע את הסטטוס הסופי של חייל בכל יום.

## 1. היררכיית מקורות המידע (Hierarchy of Truth)
כאשר המערכת מחשבת סטטוס ליום מסוים (`getEffectiveAvailability`), היא בודקת את המקורות לפי הסדר הבא (הראשון מנצח):

1.  **שינוי ידני (Manual Override)**
    *   אם קיים ב-DB רישום ידני (`source: 'manual'`) לתאריך הספציפי.
    *   זהו המקור החזק ביותר. אם מפקד קבע שחייל בבסיס - הוא בבסיס, גם אם יש בקשת יציאה.

2.  **היעדרות מאושרת (Approved Absence)**
    *   אם קיימת בטבלת `absences` רשומה בסטטוס `approved` החופפת לתאריך זה.
    *   היעדרות מאושרת גוברת על רוטציה או נגררת סטטוס, אך **לא** על שינוי ידני ספציפי לאותו יום.

3.  **שינוי ידני נגרר (Propagation / Chain Logic)**
    *   אם לא נקבע כלום עבור היום הנוכחי, המערכת מסתכלת אחורה בזמן ("גרירת סטטוס").
    *   היא מחפשת את הסטטוס הידני האחרון שהוזן ("עוגן").
    *   אם העוגן האחרון היה 'בית' -> כל הימים אחריו ייחשבו 'בית'.
    *   אם העוגן האחרון היה 'בסיס' -> כל הימים אחריו ייחשבו 'בסיס' (עד שיגיע עוגן חדש או רוטציה).
    *   **חריג:** אם הסטטוס הידני הוא "יציאה" (`departure`), יום המחרת ייחשב כ"בית" באופן אוטומטי (Propagation).

4.  **אלגוריתם / רוטציה (Rotation / Algorithm)**
    *   אם אין שינוי ידני, אין היעדרות מאושרת ואין גרירה רלוונטית.
    *   המערכת בודקת את הגדרות הרוטציה (סבב) של הצוות או החייל.

---

## 2. לוגיקת הסקה ותצוגה (Inference & Display Logic)
לאחר קביעת הסטטוס הגולמי ("בסיס" או "בית"), המערכת מבצעת עיבוד נוסף (`getAttendanceDisplayInfo`) כדי להציג תוויות חכמות כמו "הגעה", "יציאה" או "חסר יציאה". חישוב זה מתבצע בזמן אמת בצד הלקוח (Frontend).

### הגדרות בסיס:
*   **Arrival (הגעה):** יום שמתחיל ב"בסיס", אך היום שלפניו היה "בית".
*   **Departure (יציאה):** יום שהוא "בסיס", אך מוגדרת בו שעת יציאה מפורשת (שאינה 23:59).

### מקרי קצה ולוגיקות מיוחדות:

#### א. זיהוי "שעת פנטום" (Phantom Start) - 10:00
*   **הבעיה:** לעיתים המערכת מקבלת שעת התחלה דיפולטיבית של `10:00` או `10`, גם כשלא מדובר בהגעה אמיתית אלא בהמשך שהות.
*   **הפתרון:** המערכת מתעלמת משעה זו (`isPhantomStart`) ולא מחשיבה אותה כהגעה.
*   **תוצאה:** אם חייל היה בבסיס אתמול, והיום מופיע בבסיס עם שעה `10:00`, זה **לא** ייחשב כהגעה אלא כיום בסיס רגיל (רצף).

#### ב. יום בודד (Single Day)
*   תנאי: יום שהוא גם `isArrival` (הגיע מהבית) וגם `isDeparture` (יוצא באותו יום).
*   תצוגה: "יום בודד" (עם שעות).

#### ג. חסר יציאה (Missing Departure)
*   תנאי: הסטטוס הנוכחי הוא "בסיס" או "הגעה", **אבל** יום המחרת הוא "בית" (או "לא זמין").
*   בנוסף: לא הוזנה שעת יציאה מפורשת ביום הנוכחי (השעה היא 23:59).
*   משמעות: המערכת "מבינה" שהחייל יצא הביתה (כי מחר הוא בבית), אך המשתמש שכח לעדכן את שעת היציאה היום.
*   תצוגה: "בסיס (חסר יציאה)" / "הגעה (חסר יציאה)" עם סימון אדום.

#### ד. חסר הגעה (Missing Arrival)
*   תנאי: הסטטוס הוא "יציאה" (יש שעת סיום מוקדמת), **אבל** היום לא זוהה כ"הגעה" (כי לא באנו מהבית לפי הנתונים היבשים) וגם לא היינו בבסיס אתמול (רצף שבור).
*   תצוגה: "יציאה (חסר הגעה)" - מצב נדיר המעיד על חוסר עקביות בנתונים.

---

## 3. עדכונים ושינויי סטטוס (Write Logic)
הלוגיקה המרכזית לעדכונים נמצאת ב-`AttendanceManager.tsx` -> `handleUpdateAvailability`.

### בעת עדכון סטטוס ידני:
1.  **ניקוי חסימות:** אם משנים סטטוס (למשל מ'בית' ל'בסיס'), חסימות לו"ז (Unavailable Blocks) ישנות נמחקות כדי למנוע סתירות.
2.  **פתרון קונפליקטים (Conflict Resolution):** 
    *   אם משתמש מעביר חייל לסטטוס "בסיס" באופן ידני בתאריך שבו יש "היעדרות מאושרת" -> ההיעדרות המאושרת **מבוטלת אוטומטית** (משתנה ל-`rejected`).
    *   מוצגת הודעה למשתמש: "היעדרות מאושרת לחפיפה זו בוטלה עקב שינוי ידני לבסיס".
3.  **בדיקת שיבוצים (Tasks):**
    *   אם מנסים להעביר חייל ל"בית" בתאריך שיש לו בו משימות/שיבוצים פעילים -> המערכת מקפיצה **התראת אישור (Confirmation Modal)**.

---

## 4. מילון נתונים (Data Objects)
אובייקט הזמינות היומי (`DailyPresence`) נשמר כשדה JSON בתוך טבלת `people` (או טבלה נפרדת `daily_presence` בגרסאות חדשות).

מבנה אופייני:
```json
"2026-01-28": {
  "isAvailable": true,      // האם החייל זמין לשיבוץ?
  "status": "base",         // סטטוס גולמי: base, home, unavailable
  "startHour": "00:00",     // שעת התחלה בבסיס
  "endHour": "23:59",       // שעת סיום בבסיס
  "source": "manual",       // manual (ידני) או algorithm (רוטציה/אוטומטי)
  "homeStatusType": "gimel" // פירוט אם בבית (ג', חופש, נפקד...)
}
```

## סיכום
המערכת נותנת עדיפות תמיד לפעולת המשתמש (Manual), אך משלימה פערים באמצעות לוגיקה חכמה של "גרירה" והסקה ויזואלית (Arrival/Departure) כדי לחסוך עבודה ידנית ולשקף את המציאות בצורה המדויקת ביותר.
